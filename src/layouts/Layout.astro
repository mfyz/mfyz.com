---
import { ViewTransitions } from "astro:transitions";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import JSONLDSchema from "@components/JSONLDSchema.astro";
import "@styles/global.css";
import { SITE } from "@/consts";

interface Props {
  title?: string;
  description?: string;
  size?: "small" | "large";
  noContentWrapperClass?: boolean;
  lang?: string;
  frontmatter?: Record<string, any>;
}

// Get properties from Astro.props and handle frontmatter data
const pageFrontmatter = Astro.props.frontmatter || {};

// Merge frontmatter and props, giving props priority
const { title, description, size, noContentWrapperClass, lang } = {
  ...pageFrontmatter,
  ...Astro.props,
};

const pathname = Astro.url.pathname;
const {
  website,
  author,
  description: defaultDescription,
  ogImage,
  title: defaultTitle,
} = SITE;

// Generate canonical URL
const canonicalURL = new URL(pathname, website).toString();

// Extract title from frontmatter, props, or use default
const rawTitle = pageFrontmatter.title || title || defaultTitle;
const pageDescription = description || defaultDescription;

// Format title consistently: "Page Title - mfyz.com" for pages with custom titles
const formattedTitle =
  rawTitle !== defaultTitle ? rawTitle : `${SITE.title} - ${SITE.description}`;

// Set language based on frontmatter
const pageLang = lang || "en";

const ogImageBasedOnPath =
  pathname === "/"
    ? ogImage
    : `${pathname}${pathname.endsWith("/") ? `` : `/`}og.png`;
---

<!doctype html>
<html lang={pageLang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="theme-color"
      content="#f5f5f4"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#1f2937"
      media="(prefers-color-scheme: dark)"
    />

    <!-- General Meta Tags -->
    <title>{formattedTitle}</title>
    <meta name="title" content={formattedTitle} />
    <meta name="description" content={pageDescription} />
    <meta name="author" content={author} />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="200x200" />

    <!-- RSS Feed Discovery -->
    {
      pageLang === "tr" ? (
        <link
          rel="alternate"
          type="application/rss+xml"
          title="mfyz (Türkçe)"
          href="/tr/rss.xml"
        />
      ) : (
        <link
          rel="alternate"
          type="application/rss+xml"
          title="mfyz"
          href="/rss.xml"
        />
      )
    }

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content={formattedTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={website + ogImageBasedOnPath} />
    <meta property="og:image:height" content="600" />
    <meta property="og:image:width" content="800" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />

    <!-- Twitter -->
    <meta property="twitter:title" content={formattedTitle} />
    <meta property="twitter:description" content={pageDescription} />
    <meta property="twitter:image" content={website + ogImageBasedOnPath} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image:width" content="800" />
    <meta name="twitter:image:height" content="600" />

    {
      import.meta.env.PUBLIC_VERCEL_ENV === "production" && (
        <>
          <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-L5KRCLT50D"
          />
          <Fragment
            set:html={`
            <script is:inline>
              const isAdmin = document.cookie.includes('mfyz_admin=');
              if (!isAdmin) {
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-L5KRCLT50D');
              }
            </script>
            `}
          />
        </>
      )
    }

    <ViewTransitions />

    <!-- JSON-LD Structured Data -->
    <JSONLDSchema type="website" />

    <!-- Named slot for additional head content (e.g., blog post markdown source link) -->
    <slot name="head" />
  </head>

  <body
    class="grid min-h-screen grid-rows-[1fr_auto] bg-white text-text dark:bg-gray-900 dark:text-gray-200"
    style="scrollbar-gutter: stable"
  >
    <Header size={size} lang={pageLang} />
    <main
      class={`container ${size === "small" ? "mt-16 pt-8 px-1 md:px-3 lg:px-4" : "mt-24"} pb-4`}
      style="scrollbar-gutter: stable; max-width: 100vw;"
    >
      <div
        class={`${noContentWrapperClass ? "" : "main-content-wrapper"} mx-auto max-w-${size === "small" ? "3xl" : "5xl"}`}
      >
        <slot />
      </div>
    </main>

    <!-- Code block enhancement script -->
    <script src="/js/code-blocks.js" is:inline></script>

    <!-- Mermaid diagrams enhancement script -->
    <script src="/js/mermaid.js" is:inline></script>

    <!-- Link preview cards script -->
    <script src="/js/link-preview.js" is:inline></script>

    <Footer lang={pageLang} size={size} />
  </body>
</html>
